# 一个下午
- 背景：学习项目的部署。之前一直没有解决，今天抽空解决一下。
- 发现了很多错误，这一个下午挺值的。
---
# 主要问题
<thinking>
这个问题本质上是关于Web应用的上下文路径（Context Path）或上下文根（Context Root）的问题。

最初的问题是：
1. 默认情况下，Tomcat会用war包名作为上下文路径
2. 这导致所有资源访问都需要包含这个路径前缀
3. 我们通过部署到ROOT来避免这个问题

这是Web应用部署中的一个典型概念。
</thinking>

# Web应用上下文路径（Context Path）问题

## 问题描述
最初部署时，war包名为`CakeShop-1.0-SNAPSHOT.war`，这导致：
- 应用访问路径变成：`http://localhost:8080/CakeShop-1.0-SNAPSHOT/`
- 所有静态资源路径也需要包含这个前缀
- 例如图片路径：`http://localhost:8080/CakeShop-1.0-SNAPSHOT/picture/1.jpg`

## 解决方案
我们采用了将应用部署到Tomcat的ROOT目录的方案：
- 将war包重命名为`ROOT.war`
- 这样应用就会部署在上下文根路径（/）下
- 访问路径简化为：`http://localhost:8080/`
- 静态资源路径也相应简化：`http://localhost:8080/picture/1.jpg`

## 其他可选方案
1. 修改web.xml中的路径映射
2. 在JSP中使用`${pageContext.request.contextPath}`
3. 配置Tomcat的`server.xml`修改应用的上下文路径

## 为什么选择ROOT部署
1. 配置最简单
2. 不需要修改代码
3. 避免了路径相关的各种问题
4. 符合单应用部署的最佳实践

这个问题在Java Web开发中很常见，理解上下文路径的概念对于web应用部署很重要。

---
## 以下是Claude留档文件
<thinking>
我将按照以下结构组织这个部署文档：

1. 项目背景和目标
2. 环境准备
3. 部署步骤
4. 问题解决
5. 最终配置

重点突出关键步骤和解决方案，便于日后参考。
</thinking>

# Java Web项目Docker部署指南

## 1. 项目背景
本文档记录了将Java Web项目（CakeShop）部署到Docker环境的完整过程。项目使用Tomcat作为Web服务器，MySQL作为数据库，使用c3p0连接池管理数据库连接。

## 2. 环境准备
- Docker环境
- MySQL 5.7镜像
- Tomcat 9.0-jdk8镜像
- 项目war包（Maven构建）

## 3. 部署步骤

### 3.1 创建Docker网络
```powershell
docker network create cake-network
```

### 3.2 部署MySQL容器
```powershell
docker run -d --name mysql-cake \
  --network cake-network \
  -v "D:/{path}/CakeShop/CakeShop/mysql:/var/lib/mysql" \
  -e MYSQL_ROOT_PASSWORD=password \
  mysql:5.7
```

### 3.3 配置数据库连接
修改c3p0-config.xml配置：
```xml
<?xml version="1.0" en{path}="UTF-8"?>
<c3p0-config>
    <default-config>
        <property name="driverClass">com.mysql.cj.jdbc.Driver</property>
        <property name="jdbcUrl">jdbc:mysql://mysql-cake:3306/CookieShop?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=UTC&amp;useUnicode=true&amp;characterEn{path}=utf8</property>
        <property name="user">root</property>
        <property name="password">password</property>
    </default-config>
</c3p0-config>
```

### 3.4 导入数据库
使用cmd（不是PowerShell）执行以下命令：
```batch
docker exec -i mysql-cake mysql -uroot -ppassword --default-character-set=utf8 cookieshop < cookieshop.sql
```

### 3.5 部署Tomcat
1. 重命名war包为ROOT.war（实现根路径访问）
2. 启动Tomcat容器：
```powershell
docker run -d --name tomcat-cake \
  --network cake-network \
  -p 8080:8080 \
  -v "D:/{path}/CakeShop/CakeShop/target:/usr/local/tomcat/webapps" \
  tomcat:9.0-jdk8
```

## 4. 问题解决

### 4.1 数据库连接问题
- 问题：最初使用localhost无法连接数据库
- 解决：在Docker网络中使用容器名（mysql-cake）替代localhost
- 说明：Docker容器间通信需要使用容器名或IP，不能使用localhost

### 4.2 字符编码问题
- 问题：中文显示乱码
- 解决：
  1. 指定正确的数据库字符集
  2. 在JDBC URL中添加字符编码参数
  3. 使用正确的字符集导入数据

### 4.3 路径访问问题
- 问题：静态资源访问路径不正确
- 解决：将应用部署为ROOT应用，简化访问路径
- 操作：重命名war包为ROOT.war

## 5. 最终配置验证
- 访问首页：http://localhost:8080/
- 图片访问：http://localhost:8080/picture/xx.jpg
- 数据库连接：成功建立并可以正常访问数据

## 6. 注意事项
1. 确保Docker网络正确创建和配置
2. PowerShell中的重定向操作需要使用cmd替代
3. 数据库字符集配置非常重要
4. 文件路径使用正斜杠(/)，避免使用反斜杠(\)

这个部署过程展示了在Docker环境中配置Java Web应用的完整流程，包括网络配置、数据库设置、应用部署等各个方面。通过正确的配置和问题解决策略，最终实现了应用的成功部署。